import json
import threading
import time
import random
from typing import List, Dict, Optional, Tuple
from utils.maptool import MapMaintenanceTool
from utils.llm_call import llm_call_skip
from event.templates import template_poi_real_location_assign

# 模拟Mind类中的remove_json_wrapper方法
def remove_json_wrapper(input_str: str) -> str:
    """
    移除JSON字符串的前后包装（如```json ```标签、非法转义字符等）
    """
    import re
    # 步骤1：去除开头的```json（含空格/换行）和结尾的```（含空格）
    pattern = r'^\s*```json\s*\n?|\s*```\s*$'
    result = re.sub(pattern, '', input_str, flags=re.MULTILINE)

    # 步骤2：清理 JSON 非法控制字符
    valid_pattern = r'[^\x20-\x7E\n\r\t\b\f\u4E00-\u9FFF\u3000-\u303F\uFF00-\uFFEF\u2000-\u206F\u2E80-\u2EFF]'
    result = re.sub(valid_pattern, '', result)

    # 步骤3：规范空格和换行
    result = result.strip()
    result = result.replace('\u3000', ' ')
    result = re.sub(r'\r\n?', '\n', result)
    result = re.sub(r'\n+', '\n', result)

    return result

# 独立的map函数测试版本
def map_test(persona, pt, maptools):
    """
    独立测试版本的map函数，用于测试修改后的效果
    
    参数:
    - persona: 人物画像信息
    - pt: 当前数据点
    - maptools: MapMaintenanceTool实例
    
    返回:
    - 处理后的指令字符串
    """
    try:
        # 获取真实poi数据和通行信息
        prompt = template_poi_real_location_assign.format(
            persona=persona, 
            data=pt, 
            persona_address_data=maptools._persona_address_index
        )
        
        print("\n=== 生成的Prompt ===")
        print(prompt)
        
        res = llm_call_skip(prompt, context="你是一个地图POI分析专家")
        
        print("\n=== LLM响应 ===")
        print(res)
        
        res = remove_json_wrapper(res)
        data = json.loads(res)
        
        print("\n=== 解析后的指令数据 ===")
        print(data)
        
        result, error_summary = maptools.process_instruction_route(data)
        instr = maptools.extract_poi_route_simplified(result)
        
        print("\n=== 最终生成的指令 ===")
        print(instr)
        
        if error_summary:
            print(f"\n=== 错误总结 ===")
            print(error_summary)
        
        return instr
    except Exception as e:
        print(f"\n=== 测试过程中发生错误 ===")
        print(f"错误类型: {type(e).__name__}")
        print(f"错误信息: {str(e)}")
        import traceback
        traceback.print_exc()
        return f"错误: {str(e)}"

# 测试代码
if __name__ == "__main__":
    # 1. 从配置文件读取API密钥
    import json
    try:
        with open('config.json', 'r', encoding='utf-8') as f:
            config = json.load(f)
        API_KEY = config.get('map_tool', {}).get('api_key', '')
        if not API_KEY:
            print("警告：未在配置文件中找到地图API密钥！")
            API_KEY = "your_amap_api_key"  # 备用
    except Exception as e:
        print(f"读取配置文件失败：{str(e)}")
        API_KEY = "your_amap_api_key"  # 备用
    
    # 2. 准备测试数据
    with open('data/maxiaomei/persona.json', 'r', encoding='utf-8') as f:
        persona = json.load(f)

    
    # 已有真实地点数据（用于测试type1）
    persona_address_data = [
  {
    "name": "杨柳青莱茵小镇住宅区",
    "location": "117.027423,39.118907",
    "formatted_address": "天津市天津市西青区[][]",
    "city": "天津市",
    "district": "西青区",
    "streetName": [],
    "streetNumber": [],
    "description": "马晓梅的常住家庭住址，位于天津市西青区杨柳青镇，是其日常生活和家庭活动的中心。"
  },
  {
    "name": "天津师范大学附属实验学校",
    "location": "117.118276,39.055308",
    "formatted_address": "天津市天津市西青区宾水西道延长线393号",
    "city": "天津市",
    "district": "西青区",
    "streetName": "宾水西道延长线",
    "streetNumber": "393号",
    "description": "马晓梅大女儿马小芳就读的学校，马晓梅需要定期接送或参加家长会。"
  },
  {
    "name": "杨柳青第一小学",
    "location": "117.004133,39.139514",
    "formatted_address": "天津市天津市西青区青致路2号",
    "city": "天津市",
    "district": "西青区",
    "streetName": "青致路",
    "streetNumber": "2号",
    "description": "马晓梅的儿子马小刚和小女儿马小丽就读的学校，马晓梅需要每天接送孩子上下学。"
  },
  {
    "name": "王兰庄社区老年活动中心",
    "location": "117.188809,39.054018",
    "formatted_address": "天津市天津市西青区[][]",
    "city": "天津市",
    "district": "西青区",
    "streetName": [],
    "streetNumber": [],
    "description": "马晓梅参加社区刺绣班、手工活动及邻里聚会的主要场所。"
  },
  {
    "name": "纪秀菜市场",
    "location": "117.191174,39.067183",
    "formatted_address": "天津市天津市西青区[][]",
    "city": "天津市",
    "district": "西青区",
    "streetName": [],
    "streetNumber": [],
    "description": "马晓梅日常采购家庭食材和生活用品的固定场所。"
  },
  {
    "name": "莱茵小镇美泉苑生鲜超市",
    "location": "117.025620,39.120322",
    "formatted_address": "天津市天津市西青区[][]",
    "city": "天津市",
    "district": "西青区",
    "streetName": [],
    "streetNumber": [],
    "description": "居住地莱茵小镇附近购买生活用品的超市"
  },
  {
    "name": "杨柳青新华公园",
    "location": "117.014726,39.136614",
    "formatted_address": "天津市天津市西青区[][]",
    "city": "天津市",
    "district": "西青区",
    "streetName": [],
    "streetNumber": [],
    "description": "居住地莱茵小镇附近带孩子玩耍、散步的公园"
  },
  {
    "name": "张家窝镇文体活动中心",
    "location": "117.022151,39.095011",
    "formatted_address": "天津市天津市西青区利丰道[]",
    "city": "天津市",
    "district": "西青区",
    "streetName": "利丰道",
    "streetNumber": [],
    "description": "居住地莱茵小镇附近参加手工刺绣、邻里聚会的社区活动场所"
  },
  {
    "name": "杨柳青逸夫小学",
    "location": "117.030777,39.143842",
    "formatted_address": "天津市天津市西青区柳明路2号",
    "city": "天津市",
    "district": "西青区",
    "streetName": "柳明路",
    "streetNumber": "2号",
    "description": "居住地莱茵小镇附近孩子就读的学校"
  },
  {
    "name": "西青中等专业学校公交站",
    "location": "117.025917,39.127876",
    "formatted_address": "763路区间",
    "city": "",
    "district": "",
    "streetName": "",
    "streetNumber": "",
    "description": "居住地莱茵小镇附近日常出行乘坐的公交站点"
  },
  {
    "name": "杨柳青广场公园",
    "location": "117.009662,39.140173",
    "formatted_address": "天津市天津市西青区[][]",
    "city": "天津市",
    "district": "西青区",
    "streetName": [],
    "streetNumber": [],
    "description": "接送孩子上下学的杨柳青第一小学附近带孩子玩耍的公园"
  },
  {
    "name": "青宁路公交站",
    "location": "116.998773,39.131503",
    "formatted_address": "163路",
    "city": "",
    "district": "",
    "streetName": "",
    "streetNumber": "",
    "description": "接送孩子上下学的杨柳青第一小学附近的公交站点"
  },
  {
    "name": "文玥北里社区活动中心",
    "location": "117.215469,39.082856",
    "formatted_address": "天津市天津市河西区[]38号",
    "city": "天津市",
    "district": "河西区",
    "streetName": [],
    "streetNumber": "38号",
    "description": "探望母亲张秀英时可能经过的王兰庄社区老年活动中心附近的社区活动场所"
  }
]
    
    # 当前数据点
    pt = "好的，作为一位41岁的天津家庭主妇，我将基于您提供的思考过程、今日安排意向及所有参考数据，以客观视角对2025年6月9日（星期一）的全天事件进行调整、补充与优化，确保计划事件得以执行，同时使日程更丰富、合理、连贯。\n\n### **全天事件安排表 (2025-06-09，星期一，工作日)**\n\n| 时间区间 | 事件 | 地点 | 人物 | 描述 |\n| :--- | :--- | :--- | :--- | :--- |\n| **06:20 - 06:40** | **起床与晨间保健** | 天津市西青区杨柳青镇古运河路15号家中卧室 | 马晓梅 | 在闹钟声中醒来，第一件事是想起大女儿芳芳明天的毕业典礼和中考。她按习惯先进行15分钟的肩部保健操，动作是昨天高阿姨新教的几套，边做边在心里盘算今天的待办事项。 |\n| **06:40 - 07:20** | **准备早餐与叫醒家人** | 天津市西青区杨柳青镇古运河路15号家中厨房、各卧室 | 马晓梅、马建国、芳芳、刚子、丽丽 | 洗漱后进入厨房，熬上小米粥，热上昨天家宴剩下的包子，切了一碟酱黄瓜。期间，依次叫醒丈夫建国和三个孩子。建国今天不出远门，跑市内短途，预计傍晚能正常回家吃饭。 |\n| **07:20 - 07:50** | **全家早餐** | 天津市西青区杨柳青镇古运河路15号家中餐厅 | 马晓梅、马建国、芳芳、刚子、丽丽 | 一家人围坐吃早餐。马晓梅特意给芳芳多夹了一个包子，叮嘱她“多吃点，明天精神”。她简单跟建国提了晚上要开家庭会议的事。建国点头表示支持。 |\n| **07:50 - 08:20** | **送孩子上学与丈夫出门** | 天津市西青区杨柳青镇古运河路15号家门口 → 杨柳青第一小学 → 家中 | 马晓梅、刚子、丽丽、芳芳、马建国 | 芳芳自己骑自行车去中学。马晓梅骑电动车，先送小女儿丽丽和儿子刚子到**杨柳青第一小学**（位于杨柳青镇柳口路）。在校门口，她遇到了同样送孩子的邻居刘大妈，简单寒暄了几句。返回家中时，丈夫建国也已开车出门工作。 |\n| **08:20 - 08:50** | **日常家务与刺绣副业查看** | 天津市西青区杨柳青镇古运河路15号家中 | 马晓梅 | 收拾餐桌、洗碗、简单擦拭厨房台面。随后，她拿起手机，查看微信小商店的后台。昨天（周日）寄出第一批订单后，今天上午又收到了2个新订单咨询（来自社区群里的绣友），她一一做了礼貌回复，并告知发货时间。 |\n| **08:50 - 09:40** | **前往市场采购健脑食材** | 家中 → 天津市西青区杨柳青镇御河道便民市场 | 马晓梅、市场摊贩、邻居高阿姨 | 骑电动车前往**御河道便民市场**。她目标明确，先到相熟的水产摊挑了条新鲜的鲈鱼，请摊主帮忙清理干净；接着去干货摊称了半斤核桃；最后在蔬菜摊买了西兰花、蓝莓和一把小葱。采购时，正好碰见也在买菜的高阿姨，两人站在摊位边聊了会儿。高阿姨又补充了几个备考食谱细节，马晓梅认真记在手机备忘录里。 |\n| **09:40 - 10:10** | **回家处理食材与记账** | 天津市西青区杨柳青镇古运河路15号家中厨房 | 马晓梅 | 回到家，将采购的食材归位。把鲈鱼用料酒和姜片腌上，放入冰箱。拿出部分核桃，用夹子仔细剥出核桃仁，准备晚上用。同时，她打开手机记账APP，将上午的买菜支出（鲈鱼28元、核桃15元、蔬菜12元）记录清楚。 |\n| **10:10 - 11:00** | **针对性家务与线上互动** | 天津市西青区杨柳青镇古运河路15号家中客厅、阳台 | 马晓梅 | 趁着阳光好，将芳芳明天要穿的毕业典礼礼服（白衬衫和深蓝色百褶裙）从衣柜取出，挂在阳台通风处。随后，她给阳台的薄荷、香茅草和辣椒苗浇了水。休息间隙，她看到“运河人家”公众号推送了新的文章（非关于她的采访），便浏览了一下，并给昨天发布的关于自己的采访文章点了个赞。 |\n| **11:00 - 11:40** | **准备个人午餐与短暂休息** | 天津市西青区杨柳青镇古运河路15号家中厨房、客厅 | 马晓梅 | 用早上剩下的小米粥，加了一把青菜，煮了一碗菜粥作为自己的午餐。就着酱黄瓜吃完后，她将碗筷洗净。随后在客厅沙发上靠着休息了20分钟，闭目养神，但脑子里仍在过下午要熨衣服的流程。 |\n| **11:40 - 12:30** | **处理刺绣订单与材料整理** | 天津市西青区杨柳青镇古运河路15号家中刺绣角 | 马晓梅 | 来到属于她的小小刺绣角。她根据上午收到的订单需求，找出相应的绣布和彩线，开始为新的“福”字杯垫备料。严格遵守“工作20分钟休息10分钟”的节奏，期间起身活动了肩颈。 |\n| **12:30 - 14:00** | **午休与线上沟通** | 天津市西青区杨柳青镇古运河路15号家中卧室 | 马晓梅 | 躺在床上进行午休，但并未完全睡着。她用微信给芳芳发了条信息：“芳，明天典礼是要求穿白衬衫黑裙子对吧？集合是上午八点在学校操场？” 芳芳很快回复确认。马晓梅又叮嘱了几句“下午回来早点，别贪玩”。之后，她刷了会儿手机，关注了一下社区团购群里的特价信息。 |\n| **14:00 - 15:30** | **熨烫毕业典礼礼服** | 天津市西青区杨柳青镇古运河路15号家中客厅 | 马晓梅 | 将阳台晾着的礼服取下，在客厅支起熨衣板。她非常仔细地熨烫白衬衫的领口、袖口和前襟，以及百褶裙的每一道褶子。每熨烫完一件，就举起来对着光检查，确保平整无皱。整个过程持续了近一个小时，期间她多次停下来做肩部环绕动作。熨好后，将衣服用衣架撑好，挂在芳芳房间门后显眼处。 |\n| **15:30 - 16:10** | **接小女儿和儿子放学** | 家中 → 杨柳青第一小学 → 家中 | 马晓梅、刚子、丽丽 | 骑电动车前往**杨柳青第一小学**接刚子和丽丽。等待时，和其他家长聊了聊孩子期末复习的情况。接到孩子后，顺路在**学校附近的鑫悦方生鲜超市**买了一盒鸡蛋和一把香菜。 |\n| **16:10 - 17:30** | **督促孩子学习与准备晚餐** | 天津市西青区杨柳青镇古运河路15号家中 | 马晓梅、刚子、丽丽 | 回家后，督促刚子和丽丽在书房写作业。她则开始在厨房忙碌晚餐：清洗鲈鱼，放上姜丝、葱段，准备清蒸；清洗西兰花和蓝莓；将中午剥好的核桃仁用烤箱微微烤香；另外还炒了个番茄鸡蛋。整个烹饪过程，她心里想着这是为芳芳备考补充营养，做得格外用心。 |\n| **17:30 - 18:20** | **全家晚餐** | 天津市西青区杨柳青镇古运河路15号家中餐厅 | 马晓梅、马建国、芳芳、刚子、丽丽 | 丈夫建国准时到家，芳芳也放学回来了。全家围坐吃饭。马晓梅特意把清蒸鲈鱼最嫩的部分夹给芳芳，并给每个孩子都分了一些核桃仁。她自己虽然没什么胃口，但在建国的眼神鼓励下，还是努力吃了半碗饭和一些青菜。饭桌上，建国问了芳芳明天的安排，气氛温馨但略带紧张。 |\n| **18:20 - 19:00** | **收拾厨房与个人放松** | 天津市西青区杨柳青镇古运河路15号家中厨房、客厅 | 马晓梅、刚子、丽丽（协助） | 收拾餐桌，洗碗。儿子刚子主动帮忙擦桌子，小女儿丽丽负责把凳子归位。收拾停当后，马晓梅给自己泡了杯淡淡的茉莉花茶，坐在客厅沙发上休息了十分钟，什么也没想，只是静静喝茶。 |\n| **19:00 - 19:30** | **召开家庭会议** | 天津市西青区杨柳青镇古运河路15号家中客厅 | 马晓梅、马建国、芳芳、刚子、丽丽 | 马晓梅郑重地召集全家在客厅坐下。她清晰地向刚子和丽丽说明，姐姐芳芳即将中考，这是家里当前最重要的事，未来一周需要全家一起创造安静的学习环境：晚上看电视要调小音量，9点后尽量保持安静，书房优先给姐姐复习用。建国首先表态支持，刚子和丽丽也懂事地点头答应。芳芳有些感动，小声说了句“谢谢爸妈，谢谢弟弟妹妹”。 |\n| **19:30 - 20:30** | **晚间亲子时光与个人事务** | 天津市西青区杨柳青镇古运河路15号家中客厅、刺绣角 | 马晓梅、刚子、丽丽 | 会议结束后，紧张的气氛缓和。马晓梅陪着刚子和丽丽看了半小时教育频道的纪录片。之后，她来到刺绣角，没有进行精细刺绣，而是安静地整理彩线，将不同颜色的丝线绕在线板上，这个过程让她感到心静。 |\n| **20:30 - 21:20** | **督促洗漱与睡前准备** | 天津市西青区杨柳青镇古运河路15号家中 | 马晓梅、芳芳、刚子、丽丽 | 督促三个孩子依次洗漱。特意去芳芳房间，看她是否在准备明天的书包和物品，并轻声鼓励她“别紧张，好好发挥”。等孩子们都回房后，她自己完成了睡前的肩部保健操。 |\n| **21:20 - 22:10** | **个人学习与睡前放松** | 天津市西青区杨柳青镇古运河路15号家中卧室 | 马晓梅 | 洗漱完毕，靠在床头。她用手机点开“天津老城厢历史文化”线上讲座的音频，选择了关于“杨柳青年画与民俗”的片段收听，这是她个人的兴趣时间。听完后，在记账APP上补记了傍晚买鸡蛋的支出，并简单回顾了今天为女儿备考所做的各项准备。 |\n| **22:10 - 22:40** | **入睡** | 天津市西青区杨柳青镇古运河路15号家中卧室 | 马晓梅 | 放下手机，关灯躺下。脑海里像过电影一样闪过今天熨烫平整的衬衫、芳芳吃饭的样子、家庭会议上孩子们认真的表情。虽然对明天的典礼和未来的中考感到压力，但想到一切都已安排妥当，家人也团结支持，心里踏实了不少。在疲惫与些许焦虑中，逐渐入睡。 |",

    
    # 3. 初始化地图工具
    maptools = MapMaintenanceTool(api_key=API_KEY, persona_address_data=persona_address_data)
    
    # 4. 运行测试
    print("开始测试map函数...")
    result = map_test(persona, pt, maptools)
    
    print("\n=== 测试完成 ===")
    print(f"最终结果: {result}")