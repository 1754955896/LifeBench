# 代码重构需求

最后更新：2026-02-27

---

## 背景

当前数据合成与 QA 合成流程耦合度较高，主要问题：

1. **流程不可复用**：pipeline 按顺序一次性执行，难以对已有数据做局部增量操作
2. **QA 类别硬编码**：新增 QA 类型需要侵入多处代码，扩展成本高
3. **数据与评测混合**：合成数据和评测数据生成逻辑耦合，不便于独立迭代

---

## 重构目标

### 1. 支持增量数据合成

**需求：** 对已经完成合成的用户数据，能够在不重新跑全流程的前提下，向已有 `daily_event.json` / `phone_data` 中**追加或修改**特定类型的记忆条目。

典型场景：
- 向现有数据中注入冲突事件（MC）
- 向现有数据中植入有害记忆条目（HM）
- 为已有事件补充显著性标注（MF）

**核心约束：** 增量操作不能破坏现有数据的 ID 体系和时间一致性。

---

### 2. 支持新增 QA 类别

**需求：** 新增一种 QA 类型时，只需在独立模块中实现该类型的生成逻辑，无需修改主流程和其他 QA 生成器。

期望能做到：
- 新 QA 类别作为独立插件挂载
- 可单独针对某个用户、某个月份运行某类 QA 生成
- 输出结果能自动合并进现有 `QA_clean.json`，不覆盖已有条目

---

### 3. 数据合成与评测解耦

**需求：** 明确划分两类职责：

| 职责 | 当前状态 | 目标状态 |
|------|---------|---------|
| 数据合成（events, phone_data） | 与 QA 生成混合 | 独立模块，输出标准化中间格式 |
| QA 生成 | 依赖合成流程内部状态 | 仅依赖标准化数据文件，可独立运行 |

---

## 不在本次范围内

- 具体架构设计（接口定义、模块划分方案）
- 性能优化
- 对现有已合成数据的格式迁移
